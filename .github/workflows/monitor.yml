name: Sync Quark APK → GitHub Release → Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests PyGithub packaging

      - name: Run monitor_worker.py
        env:
          QUARK_STOKEN: ${{ secrets.QUARK_STOKEN }}
          QUARK_ROOT_FID: ${{ secrets.QUARK_ROOT_FID }}
        run: |
          echo "▶ Running monitor_worker.py ..."
          python monitor_worker.py

      - name: Check if APK list changed
        id: check
        run: |
          hash=$(sha256sum files.json | cut -d' ' -f1)
          last=$(cat last_hash.txt 2>/dev/null || echo "")
          echo "hash=$hash" >> $GITHUB_OUTPUT
          echo "last=$last" >> $GITHUB_OUTPUT
          if [ "$hash" = "$last" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No new APKs"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "$hash" > last_hash.txt
          fi

      - name: Commit last_hash.txt
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_hash.txt
          git commit -m "Update last_hash for APK sync" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

      - name: Upload APK to GitHub Release
        if: steps.check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="auto-$(date +'%Y%m%d-%H%M')"
          echo "Creating release tag: $tag"
          git tag "$tag" || true
          git push origin "$tag" || true
          gh release create "$tag" apk/*.apk \
            --title "Quark APK $tag" \
            --notes "自动同步自 Quark Worker，仅最新 APK"

      - name: Push APK to Telegram
        if: steps.check.outputs.changed == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          BOT_API_BASE: ${{ secrets.BOT_API_BASE }}
        run: |
          media='['
          for f in apk/*.apk; do
            base=$(basename "$f")
            last=$base
            media="$media{\"type\":\"document\",\"media\":\"attach://$base\"},"
          done
          media="${media%,}]"
          caption="最新 APK 已同步至 GitHub Release"
          response=$(curl -s -X POST "$BOT_API_BASE/bot$BOT_TOKEN/sendMediaGroup" \
            -F chat_id="$CHAT_ID" \
            -F media="$media" \
            -F "$last=@$f")
          echo "Telegram response: $response"
