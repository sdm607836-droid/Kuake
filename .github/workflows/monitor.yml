name: Monitor Quark Share via Worker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Get file list from Worker
        run: |
          import os, json, requests

          # ä½ çš„ Worker URL
          WORKER_URL = "https://broad-mode-cbfa.sdm607836.workers.dev/"
          # åˆ†äº«é¡µå‚æ•°ï¼ˆä»æµè§ˆå™¨æŠ“ï¼‰
          PWD_ID = "cb0ee2b9ac64"
          STOKEN = os.getenv("QUARK_STOKEN")
          ROOT_FID = os.getenv("QUARK_ROOT_FID")

          if not STOKEN or not ROOT_FID:
              print("âŒ è¯·è®¾ç½® QUARK_STOKEN å’Œ QUARK_ROOT_FID Secrets")
              exit(1)

          # è°ƒç”¨ Worker è·å–æ–‡ä»¶åˆ—è¡¨
          resp = requests.get(
              f"{WORKER_URL}?pwd_id={PWD_ID}&stoken={STOKEN}&pdir_fid={ROOT_FID}",
              timeout=15
          )
          resp.raise_for_status()
          data = resp.json()

          if "data" not in data or "list" not in data["data"]:
              print("âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥")
              print(data)
              exit(1)

          files = data["data"]["list"]
          print(f"\nğŸ“¦ å…± {len(files)} ä¸ªæ–‡ä»¶ï¼š\n")
          for f in files:
              print(f"- {f['file_name']} | {f['size']} bytes")

      - name: Optional: Save file list to JSON
        run: |
          import json
          with open("files.json", "w", encoding="utf-8") as f:
              json.dump(files, f, ensure_ascii=False, indent=2)
