name: Monitor and Upload APK

on:
  workflow_dispatch:  # 先用手动触发测试，确认没问题后再改回 schedule
  # schedule:
  #   - cron: '0 * * * *'

jobs:
  check_apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 PyGithub

      - name: Run APK monitor script
        env:
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}
          APK_URL: 'https://pan.quark.cn/s/cb0ee2b9ac64'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: python
        run: |
          import os
          import requests
          from bs4 import BeautifulSoup
          from github import Github, GithubException

          quark_cookie_str = os.getenv("QUARK_COOKIE")
          url = os.getenv("APK_URL")

          if not quark_cookie_str or '=' not in quark_cookie_str:
              print("QUARK_COOKIE 格式错误，请检查 Secrets 设置")
              exit(1)

          cookie_key, cookie_value = quark_cookie_str.split('=', 1)
          cookies = {cookie_key.strip(): cookie_value.strip()}

          last_version_file = ".last_version"

          def get_latest_apk():
              try:
                  resp = requests.get(url, cookies=cookies, timeout=20)
                  resp.raise_for_status()
                  soup = BeautifulSoup(resp.text, "html.parser")

                  apk_items = []
                  for a in soup.find_all("a", href=True):
                      href = a["href"]
                      text = a.get_text(strip=True)
                      if ".apk" in href.lower():
                          apk_items.append((text or href, href))

                  if not apk_items:
                      print("页面中未找到任何 .apk 相关链接")
                      return

                  latest_text, latest_href = sorted(apk_items)[-1]

                  last_version = None
                  if os.path.exists(last_version_file):
                      with open(last_version_file, "r", encoding="utf-8") as f:
                          last_version = f.read().strip()

                  if latest_text != last_version:
                      print(f"发现新版本：{latest_text}")
                      print(f"链接：{latest_href}")

                      with open(last_version_file, "w", encoding="utf-8") as f:
                          f.write(latest_text)

                      download_and_upload(latest_href, latest_text)
                  else:
                      print("没有新版本")

              except Exception as e:
                  print(f"获取/解析页面失败：{type(e).__name__} {str(e)}")

          def download_and_upload(href, version_str):
              try:
                  if not href.startswith(('http://', 'https://')):
                      base = os.getenv("APK_URL").rstrip('/') + '/'
                      full_url = base + href.lstrip('/')
                  else:
                      full_url = href

                  print(f"即将下载：{full_url}")

                  r = requests.get(full_url, cookies=cookies, stream=True, timeout=60)
                  r.raise_for_status()

                  safe_version = version_str.replace(' ', '_').replace('/', '-')
                  filename = f"{safe_version}.apk"

                  with open(filename, "wb") as f:
                      for chunk in r.iter_content(chunk_size=8192):
                          if chunk:
                              f.write(chunk)

                  print(f"下载完成：{filename} ({os.path.getsize(filename)} bytes)")

                  g = Github(os.getenv("GITHUB_TOKEN"))
                  repo = g.get_repo(os.getenv("GITHUB_REPOSITORY"))

                  try:
                      release = repo.get_release(version_str)
                      print(f"Release {version_str} 已存在")
                  except GithubException as exc:
                      if exc.status == 404:
                          release = repo.create_git_release(
                              tag=version_str,
                              name=version_str,
                              message="自动监控上传的 APK",
                              draft=False,
                              prerelease=False
                          )
                          print(f"创建了新 Release：{version_str}")
                      else:
                          raise

                  release.upload_asset(
                      filename,
                      name=filename,
                      content_type="application/vnd.android.package-archive",
                      label=f"APK - {version_str}"
                  )
                  print("Asset 上传成功")

              except Exception as e:
                  print(f"下载或上传失败：{type(e).__name__} {str(e)}")

          if __name__ == "__main__":
              get_latest_apk()
