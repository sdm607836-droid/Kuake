name: Monitor and Upload APK

on:
  schedule:
    - cron: '0 * * * *'  # 每小时运行一次

jobs:
  check_apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run APK monitor script
        env:
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}  # 从 GitHub Secrets 引用 Cookie
          APK_URL: 'https://pan.quark.cn/s/cb0ee2b9ac64'  # 替换为你的夸克网盘链接
        run: |
          python - <<EOF
import os
import requests
from bs4 import BeautifulSoup

# 获取 Cookie 和 APK 链接
cookies = {
    'cookie_name': os.getenv('QUARK_COOKIE').split('=')[0]: os.getenv('QUARK_COOKIE').split('=')[1]  # 从环境变量获取 Cookie
}

url = os.getenv('APK_URL')

# 记录上次下载的 APK 版本
last_version_file = ".last_version"

def get_latest_apk():
    global last_version
    try:
        response = requests.get(url, cookies=cookies)
        response.raise_for_status()

        soup = BeautifulSoup(response.text, 'html.parser')

        apk_links = []
        for link in soup.find_all('a'):
            href = link.get('href')
            text = link.text.strip()
            if href and '.apk' in href:
                apk_links.append((text, href))

        if apk_links:
            latest_version, latest_link = sorted(apk_links, key=lambda x: x[0])[-1]

            if os.path.exists(last_version_file):
                with open(last_version_file, 'r') as f:
                    last_version = f.read().strip()
            else:
                last_version = None

            if latest_version != last_version:
                print(f"发现新版本: {latest_version}, 下载链接: {latest_link}")

                # 记录新版本
                with open(last_version_file, 'w') as f:
                    f.write(latest_version)
                
                download_apk(latest_link)
            else:
                print("未发现新版本。")
        else:
            print("未找到 APK 下载链接。")
    except Exception as e:
        print(f"发生错误: {e}")

def download_apk(link):
    try:
        apk_response = requests.get(link, cookies=cookies)
        apk_response.raise_for_status()

        filename = f"{latest_version}.apk"
        with open(filename, 'wb') as f:
            f.write(apk_response.content)

        print(f"APK '{filename}' 下载成功。")
        upload_to_github(filename)
    except Exception as e:
        print(f"下载失败: {e}")

def upload_to_github(filename):
    from github import Github
    g = Github(os.getenv('GITHUB_TOKEN'))
    repo = g.get_repo(os.getenv('GITHUB_REPOSITORY'))

    with open(filename, 'rb') as f:
        repo.create_git_release(tag=latest_version, name=latest_version, message='Automated APK upload',
                                 asset=f)

if name == "__main__":
    get_latest_apk()
EOF
